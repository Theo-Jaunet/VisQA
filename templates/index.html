<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Basic Page Needs
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>Projection</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="{{ url_for('static', filename='assets/js/umap.js')}}"></script>
    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/normalize.css')}}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/skeleton.css')}}">

    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href=" {{ url_for('static', filename='assets/images/favicon/favicon.ico')}}   ">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <style>

        input::-webkit-calendar-picker-indicator {
            opacity: 100;
        }

        label, select, input, button {

            margin: 2px;
        }

        .selected {

            fill: #444444;
            stroke: #D1D1D1;
        }

        .selected:hover {
            fill: #a9a9a9 !important;
        }

        #model rect {
            cursor: pointer;
        }


        #model rect:hover {
            cursor: pointer;
            fill: #333333;
            stroke: #D1D1D1;
        }

        .actFilted {

            border: #333333 solid 1px;
            margin: 2px;
            display: inline-block;
            cursor: pointer;
        }


        .actFilted:hover {


            background-color: #a9a9a9 !important;
        }

        .kmeanSelected {
            background-color: #444444 !important;
        }


        body {

            user-select: none;
        }
    </style>
</head>
<body>
<script src="{{ url_for('static', filename='assets/js/main.js')}}"></script>
<script src="{{ url_for('static', filename='assets/js/mapsHandler.js')}}"></script>

<!-- Primary Page Layout
–––––––––––––––––––––––––––––––––––––––––––––––––– -->


<div class="container" style="margin-bottom: 5%;margin-left: auto">


    <div class="row">
        <div class="twelve column" style="text-align: center;margin-top: 4%;position: relative">

            <div id="asker" style="position: absolute;left:-420px;top:5%">
                <div style=";background-color: #fafafa;border: thin solid #f3f3f3;padding: 1.125em;">
                    <input type="text" id="ask-quest" style="width: 250px"
                           placeholder="Ask a question about the picture" list="productName">
                    <datalist id="productName">
                        <option value="bob">bob</option>
                    </datalist>
                    <button class="button-primary" style="display:inline-block;" id="ask">Ask</button>
                </div>
                <div style="width: 300px;height: 320px;margin-top:40px">
                    <canvas id="inVis"
                            style=";background-color: #fafafa;border: thin solid #f3f3f3;padding: 1.125em;"></canvas>
                    <input type="range" id="imSlide" min="0" value="0" class="u-full-width">
                </div>


                <div style="margin-top: 60px">
                    <svg id="sceneGraph"
                         style="width: 80%;height:
                         400px;background-color: #fafafa;border: thin solid #f3f3f3;padding: 0.125em;"></svg>
                </div>

            </div>

            <div style="position: absolute;left: 1020px;top: 32%">


                <svg width="150" id="res"
                     style=";background-color: #fafafa;border: thin solid #f3f3f3;padding: 1.125em;">

                </svg>
                <!--                <p id="result"-->
                <!--                   style="text-align: center;display:block;margin-top: 5px;margin-bottom: 5px;font-weight: 600;background-color: #fafafa;border: thin solid #f3f3f3;padding: 1.125em;"></p>-->
            </div>


            <div style="width: 100%;position: relative">

                <svg id="model"
                     style="width: 100%;height: 280px;margin-top: 30px;background-color: #fafafa;border: thin solid #f3f3f3;padding: 1.125em;"></svg>
                <div style="position: absolute;left: 50%;top: 32%;visibility: hidden" id="loader">
                    <img src="static/assets/images/load.gif" style="width: 85px"/>
                    <h3> Loading ... </h3>
                </div>
                <div style="display: inline-block;position: absolute;left: 0%;">

                    <div style="position: relative;display: inline-block;left: 0">
                        <button id="saveState"> Save</button>
<!--                        <button id="makeDiff"> AbsDiff</button>-->
                        <button id="fullDiff">
                            Comapre
                        </button>
                        <select style="display: inline-block;margin-right: 25px" class="one-half" id="models">

                        </select>
                        <span style="margin-top: -20%">K-Median 0</span>
                        <div style="display: inline-block;vertical-align: middle">
                            <div style="background-color: #bbd8e6;width: 30px;height: 30px" class="actFilted"
                                 num="0"></div>
                            <div style="background-color: #cbecaf;width: 30px;height: 30px" class="actFilted"
                                 num="1"></div>
                            <div style="background-color: #f8e4c5;width: 30px;height: 30px" class="actFilted"
                                 num="2"></div>
                            <div style="background-color: #f3cfdb;width: 30px;height: 30px" class="actFilted"
                                 num="3"></div>
                        </div>
                        <span> K-Median 100 </span>

                        <div id="counter">
                            Masked Heads:
                        </div>
                    </div>
                    <button class="button" id="resetMod" style="position: absolute;margin-left: 20px"> reset Selection
                    </button>
                </div>
            </div>

        </div>

    </div>

    <div class="row" style="margin-top: 14%">
        <div class="twelve column" style="margin-top: 0.2%">

            <div style="width:100%;height: 640px;position: relative">
                <!--                <div style="width: 100%;text-align: center;margin-bottom: 10px">-->
                <!--                    <button class="button-primary" id="go" style="padding: 0 15px"> Make Proj</button>-->
                <!--                    <label style="display: inline-block" for="ggroup">-->
                <!--                        Global Group-->
                <!--                    </label>-->
                <!--                    <select class="one-half" id="ggroup" style="display: inline-block">-->
                <!--                    </select>-->
                <!--                    <label style="display: inline-block" for="function">-->
                <!--                        Function</label>-->
                <!--                    <select style="display: inline-block" class="one-half" id="function">-->

                <!--                    </select>-->

                <!--                    <label style="display: inline-block" for="question">Question</label>-->
                <!--                    <input style="display: inline-block" type="text" class="one-half" id="question">-->
                <!--                    <button class="button-primary" id="reset" style="padding: 0 15px"> reset</button>-->
                <!--                </div>-->


                <!--                <div style="width:48%;height: 68%;border: #555555 solid 1px;position: relative;display:inline-block">-->
                <!--                    <svg id="proj" style="height: 100%;width:100%" viewBox="0 0 960 642">-->

                <!--                    </svg>-->
                <!--                </div>-->
                <div style="width:60%;height: 78%;position: relative;display: inline-block;background-color: #fafafa;border: thin solid #f3f3f3;padding: 0.125em;">
                    <canvas style="width: 100%;height: 100%" id="heatm"></canvas>
                </div>
            </div>
        </div>

    </div>


</div>


<script>
    // load_data_light().then(r => init(r));

    const keymap = {};
    onkeyup = function (e) {
        if (e.keyCode in keymap) {
            keymap[e.keyCode] = false;
        }
    };

    onkeydown = function (e) {
        e = e || event;
        keymap[e.keyCode] = e.type === 'keydown';

    };


    $("#saveState").on("click", function () {

        oldKmean = JSON.parse(JSON.stringify(currKmean)) // DEEP COPY
        oldHeatmaps = JSON.parse(JSON.stringify(currHeatmaps)) // DEEP COPY
        oldHeatLabels = JSON.parse(JSON.stringify(currHeatLabels)) // DEEP COPY

    });


    $("#makeDiff").on("click", function () {

        let hk = Object.keys(currHeatmaps)

        $(this).toggleClass("button-primary")

        let diffHeat = {};
        let svg = d3.select("#model")
        for (let i = 0; i < hk.length; i++) {
            diffHeat[hk[i]] = makeDiff(currHeatmaps[hk[i]], oldHeatmaps[hk[i]])
            svg.select("#" + hk[i]).attr("fill", diff_col(agDiff(diffHeat[hk[i]])));

        }

        currDiffHeat = diffHeat;
        diff_bool = !diff_bool
        fdiff_bool = !fdiff_bool


    });


    $("#fullDiff").on("click", function () {

        let hk = Object.keys(currHeatmaps)

        $(this).toggleClass("button-primary")

        let diffHeat = {};
        let svg = d3.select("#model")
        for (let i = 0; i < hk.length; i++) {
            diffHeat[hk[i]] = makeDiff2(currHeatmaps[hk[i]], oldHeatmaps[hk[i]])
            console.log(hk[i]);
            console.log(currHeatmaps[hk[i]]);
            console.log(oldHeatmaps[hk[i]]);
            console.log(diffHeat[hk[i]]);
            console.log("-------------");
            svg.select("#" + hk[i]).attr("fill", diff_col(agDiff(diffHeat[hk[i]])));

        }

        currDiffHeat = diffHeat;
        fdiff_bool = !fdiff_bool;


    });

    $("#ggroup").change(function () {

        d3.selectAll(".umapDot").style("opacity", 0.05)
        d3.selectAll(".umapDot").filter(d => d.global_group === this.value).style("opacity", 0.8).attr("r", 4)
    })


    $("#function").change(function () {

        d3.selectAll(".umapDot").style("opacity", 0.05)
        d3.selectAll(".umapDot").filter(d => d.functions.indexOf(this.value) >= 0).style("opacity", 0.8).attr("r", 4)
    })


    $("#reset").on("click", function () {

        d3.selectAll(".umapDot").style("opacicty", 0.8).attr("r", 2.5)

    })


    $("#question").change(function () {
        d3.selectAll(".umapDot").style("opacity", 0.05)
        d3.selectAll(".umapDot").filter(d => d.question.toLowerCase().includes(this.value.toLowerCase())).style("opacity", 0.8).attr("r", 4)
    })


    $("#resetMod").click(function () {
        attsMaps = [];
        d3.selectAll("#model rect").attr("class", "");
        $(".kmeanSelected").toggleClass("kmeanSelected")
    })

    $("#go").click(function () {

        d3.select("#proj").transition().duration(470).style("opacity", "0.2")
        $("#loader").css("visibility", "visible")

        let form = new FormData();
        form.append("units", attsMaps);

        $.ajax({
            type: "POST",
            url: "/proj",
            processData: false,
            contentType: false,
            data: form,
            success: function (d) {
                d = JSON.parse(d);

                for (let i = 0; i < curData.length; i++) {
                    curData[i].k_dist = d["proj"][i]
                }
                plotter_init(curData)

                d3.select("#proj").transition().duration(170).style("opacity", "1")
                $("#loader").css("visibility", "hidden")
            }
        })
    });


    $(".actFilted").on("click", function () {

        let elem = $(this)
        let threshes = [20, 35, 70, 101];
        let bases = [0, 20, 35, 70]
        let nb = elem.attr("num")


        let temp = findElems(currKmean, threshes[nb], bases[nb])

        // console.log(temp);

        if (keymap[16]) {
            attsMaps = union_arrays(attsMaps, temp)
        } else {
            console.log('lalala');
            attsMaps = temp
            $(".kmeanSelected").toggleClass("kmeanSelected")
        }

        d3.selectAll("#model rect").attr("class", "");
        for (let i = 0; i < attsMaps.length; i++) {
            d3.select("#" + attsMaps[i]).attr("class", "selected")
        }

        elem.toggleClass("kmeanSelected")
        UpdateCounter()


    });


    $("#ask-quest").change(function () {
        let form = new FormData();
        form.append("units", attsMaps);
        form.append("question", $("#ask-quest").val());
        form.append("image", imgs[$("#imSlide").val()] + ".jpg");

        $.ajax({
            type: "POST",
            url: "/ask",
            processData: false,
            contentType: false,
            data: form,
            success: function (d) {
                ask(d)
            }
        })
    })

    $("#ask").click(function () {
        let form = new FormData();
        form.append("units", attsMaps);
        form.append("question", $("#ask-quest").val());
        form.append("image", imgs[$("#imSlide").val()] + ".jpg");

        $.ajax({
            type: "POST",
            url: "/ask",
            processData: false,
            contentType: false,
            data: form,
            success: function (d) {
                ask(d)
            }
        })

    })


    $("#model").on("click", "rect", function () {
        console.log('lalal');

        let elem = $(this);
        let type = elem.attr("type");
        let name = elem.attr("name");
        let nb = elem.attr("nb");


        if (type === "0") {
            console.log("block");

            let temp = block2names(name, nb);

            if (keymap[16]) {
                attsMaps = union_arrays(attsMaps, temp)
            } else {
                attsMaps = temp
            }

        } else if (type === "1") {
            let temp = layer2names(name, nb);

            if (keymap[16]) {
                attsMaps = union_arrays(attsMaps, temp)
            } else {
                attsMaps = temp
            }

        } else if (type === "2") {
            let temp = [elem.attr("id")]

            if (keymap[16]) {
                attsMaps = union_arrays(attsMaps, temp)
            } else {
                attsMaps = temp
            }

        }

        console.log(attsMaps);

        d3.selectAll("#model rect").attr("class", "");
        for (let i = 0; i < attsMaps.length; i++) {
            d3.select("#" + attsMaps[i]).attr("class", "selected")
        }
        UpdateCounter()
    });

    $("#imSlide").on("input", function () {

        let im = new Image();
        let val = imgs[$(this).val()]

        im.onload = function () {

            let can = document.getElementById("inVis")

            let cont = can.getContext('2d');

            imShown = im
            let rate = fixRatio2([im.width, im.height], [300, 300])

            can.width = rate[0]
            can.height = rate[1]

            cont.drawImage(im, 0, 0, rate[0], rate[1])
        };

        im.src = baseUrl + val + ".jpg"
        if (modType === 'oracle') {
            fillQuest(val)
        }
    })


    $("#model").on("mouseover", "rect", function () {

        let elem = $(this)
        if (!keymap[17]) {

            if (asked && elem.attr("type") == 2) {

                let id = elem.attr("id")

                let data = currHeatmaps[id];

                if (diff_bool || fdiff_bool) {
                    data = currDiffHeat[id]
                }

                drawHeat(data, id, [0, 0]);
                curHeat = data;
                curname = id
            }
        }
    });


    d3.select("#heatm").on("mousemove", function () {
        if (curname) {

            let data = currHeatmaps[curname];

            if (diff_bool || fdiff_bool) {
                data = currDiffHeat[curname]
            }

            // let data = (diff_bool ? currDiffHeat[curname] : currHeatmaps[curname])
            drawHeat(data, curname, d3.mouse(this))
        }
    })

    $("#models").on("input", function () {
        let elem = $(this)
        // console.log()
        let dis = elem.val()

        let mode = models.filter(d => d.display == dis)[0]
        console.log(mode);

        d3.select("#model").transition().duration(470).style("opacity", "0.2")
        $("#loader").css("visibility", "visible")
        switchMod(mode)

    })


</script>

</body>
</html>